#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h> 
#include <strings.h>
#include <unistd.h>

FILE *fr;

/*
 *  Function used to report an error
 */
void error(char *msg)
{
    perror(msg);
    exit(0);
}

/*
 *  Function used to abstract away the socket connection
 */
char* openconnection(char domain[]) {
  int sockfd, portno = 80, n;
  struct sockaddr_in serv_addr;
  struct hostent *server;
  char buffer[256];
  char* file_name = NULL;

  // Open a socket
  sockfd = socket(AF_INET, SOCK_STREAM, 0);
  if (sockfd < 0) {
    error("ERROR opening socket");
  }

  // Resolve the domain 
  server = gethostbyname(domain);
  if (server == NULL) {
      fprintf(stderr,"ERROR, no such host\n");
      exit(0);
  }
  bzero((char *) &serv_addr, sizeof(serv_addr));
  serv_addr.sin_family = AF_INET;
  bcopy((char *)server->h_addr, (char *)&serv_addr.sin_addr.s_addr, server->h_length);
  serv_addr.sin_port = htons(portno);

  // Try connecting to the domain
  if (connect(sockfd,(struct sockaddr *)&serv_addr,sizeof(serv_addr)) < 0) {
    error("ERROR connecting");
  }

  // Build the HTTP GET request
  bzero(buffer,256);
  char temp[256] = "GET /\r\n HTTP/1.1\r\n\r\n";
  strncpy(buffer, temp, sizeof(buffer));

  // Send the GET request to the socket
  n = write(sockfd,buffer,strlen(buffer));
  if (n < 0) {
    error("ERROR writing to socket");
  }

  // Read the response from the socket
  FILE* out = NULL;
  int print = 0;
  n = 1;  // Init to allow entrance into reading loop
  while (n) {
    bzero(buffer,256);
    n = read(sockfd,buffer,255);
    // Check for an error
    if (n < 0) {
      error("ERROR reading from socket");
    }
    // printf("%s\n", buffer);
    // Already bypassed header. Print out html to file
    if (print) {
      // Print out buffer to file
      fprintf(out, "%s", buffer);
    }
    // Check if end of header is located in this segment
    else {
      if (strstr(buffer, "\r\n\r\n") != NULL) {
        // Set up file to print out to and print out.
        if (!out) {
          // file_name = strcat(domain,".html");
          file_name = domain;
          out = fopen(file_name, "w");
        }
        fprintf(out, "%s", strstr(buffer, "\r\n\r\n")+ 4);
        print = 1;
      }
    }
  }
  // Close the opened file
  if (out) {
    fclose(out);
  }
  return file_name;
}

int testdomain(char domain[]) {
  char command[256];
  char* result = openconnection(domain);
  // printf("%s\n", result);
  // OS dependent command to open an html file
  // Safari is set up to use a proxy
  strcat(command, "open -a safari http://");
  strcat(command, result);
  system(command);
  // printf("%s\n", command);
  return 0;
}

/*
 *  Used for reading in the domain list found in domains.txt.
 *  There should only be one domain per line.
 */
int main(void) {
  FILE * fp;
  char * line = NULL;
  size_t len = 0;
  ssize_t read;

  fp = fopen("domains.txt", "r");
  if (fp != NULL) {
    while ((read = getline(&line, &len, fp)) != -1) {
      // printf("%s", line);
      size_t lindex = strlen(line) - 1;
      if (lindex > 0 && line[lindex] == '\n') {
        line[lindex] = '\0';
      }
      testdomain(line);
    }
    fclose(fp);
    if (line) {
      free(line);
    }
  }
}

